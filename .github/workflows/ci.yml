name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  diagnostics:
    name: Diagnostics
    runs-on: imprunner
    steps:
      - name: System Information
        run: |
          echo "=== System Information ==="
          hostname
          uname -a
          if [ -f /etc/os-release ]; then
            cat /etc/os-release
          fi

      - name: CPU and Memory
        run: |
          echo "=== CPU and Memory ==="
          echo "CPU Cores: $(nproc)"
          if [ -f /proc/cpuinfo ]; then
            grep "model name" /proc/cpuinfo | head -1
          fi
          free -h

      - name: Docker Information
        run: |
          echo "=== Docker Information ==="
          if command -v docker &> /dev/null; then
            docker --version
            docker info 2>/dev/null || echo "Docker daemon not running or permission denied"
          else
            echo "Docker not installed"
          fi

      - name: Python Information
        run: |
          echo "=== Python Information ==="
          if command -v python3 &> /dev/null; then
            python3 --version
            which python3
          elif command -v python &> /dev/null; then
            python --version
            which python
          else
            echo "Python not found"
          fi

      - name: Git Information
        run: |
          echo "=== Git Information ==="
          git --version
          git config --list | head -10

      - name: Available Tools
        run: |
          echo "=== Available Tools ==="
          for tool in node npm pip pip3 docker kubectl curl wget gh; do
            if command -v $tool &> /dev/null; then
              echo "$tool: $(command -v $tool)"
            else
              echo "$tool: not found"
            fi
          done

      - name: Disk Space
        run: |
          echo "=== Disk Space ==="
          df -h

      - name: Environment Variables
        run: |
          echo "=== Environment Variables ==="
          echo "PATH entries:"
          echo $PATH | tr ':' '\n' | head -10
          echo ""
          echo "GITHUB_RUNNER_OS: $RUNNER_OS"
          echo "GITHUB_RUNNER_ARCH: $RUNNER_ARCH"
          echo "GITHUB_REPOSITORY: $GITHUB_REPOSITORY"
          echo "GITHUB_RUN_ID: $GITHUB_RUN_ID"

      - name: Create Issue with Diagnostics
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "=== Creating GitHub Issue with Diagnostics ==="
          # Get all diagnostic info
          DIAGNOSTICS=$(cat << 'EOF'
          ## Runner Diagnostics Report
          
          Generated: ${{ github.run_id }}
          Runner: imprunner
          
          ### System
          ```
          $(hostname)
          $(uname -a)
          ```
          
          ### CPU/Memory
          ```
          Cores: $(nproc)
          $(free -h)
          ```
          
          ### Tools
          - Python: $(python3 --version 2>/dev/null || python --version 2>/dev/null || echo "not found")
          - Git: $(git --version)
          - Docker: $(docker --version 2>/dev/null || echo "not available")
          - Node: $(node --version 2>/dev/null || echo "not found")
          ```
          EOF
          )
          echo "$DIAGNOSTICS"

  ci:
    name: CI
    runs-on: imprunner
    needs: diagnostics
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Treat all other errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run tests with pytest
        run: |
          pytest --tb=short -v || echo "No tests found or tests failed (continuing...)"
