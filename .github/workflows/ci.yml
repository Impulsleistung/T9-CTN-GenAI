# CI workflow for T9-CTN-GenAI using imprunner self-hosted Linux X64
name: CI

# Controls when the workflow will run
on:
  # Trigger on push to all branches except main
  push:
    branches-ignore:
      - main
  # Allow manual trigger
  workflow_dispatch:

# Set permissions for the workflow (principle of least privilege)
permissions:
  contents: read
  pull-requests: write
  statuses: write
  issues: write

# A workflow run is made up of one or more jobs
jobs:
  # Diagnostic job to test runner environment
  diagnostics:
    runs-on: imprunner
    
    steps:
      # 1. System Information
      - name: System Information
        run: |
          echo "=== SYSTEM INFORMATION ==="
          echo "Hostname: $(hostname)"
          echo "OS: $(uname -a)"
          cat /etc/os-release 2>/dev/null || echo "OS details not available"

      # 2. CPU and Memory
      - name: CPU and Memory
        run: |
          echo "=== CPU AND MEMORY ==="
          echo "CPU cores: $(nproc)"
          echo "CPU info:"
          cat /proc/cpuinfo | grep "model name" | head -1 || echo "CPU info not available"
          echo "Memory:"
          free -h || echo "Memory info not available"

      # 3. Docker Information
      - name: Docker Information
        run: |
          echo "=== DOCKER INFORMATION ==="
          if command -v docker &> /dev/null; then
            docker --version
            docker info 2>/dev/null | head -20 || echo "Docker daemon not running or no access"
          else
            echo "Docker is not installed"
          fi

      # 4. Python Information
      - name: Python Information
        run: |
          echo "=== PYTHON INFORMATION ==="
          if command -v python3 &> /dev/null; then
            python3 --version
            python3 -c "import sys; print(f'Python path: {sys.executable}')"
          elif command -v python &> /dev/null; then
            python --version
            python -c "import sys; print(f'Python path: {sys.executable}')"
          else
            echo "Python is not installed"
          fi

      # 5. Git Information
      - name: Git Information
        run: |
          echo "=== GIT INFORMATION ==="
          if command -v git &> /dev/null; then
            git --version
            git config --list | head -10
          else
            echo "Git is not installed"
          fi

      # 6. Node.js and npm
      - name: Node.js and npm
        run: |
          echo "=== NODE.JS AND NPM ==="
          if command -v node &> /dev/null; then
            node --version
            npm --version
          else
            echo "Node.js is not installed"
          fi

      # 7. Available Tools
      - name: Available Tools
        run: |
          echo "=== AVAILABLE TOOLS ==="
          for tool in node npm pip pip3 docker kubectl curl wget; do
            if command -v $tool &> /dev/null; then
              echo "  $tool: $(command -v $tool)"
            else
              echo "  $tool: not found"
            fi
          done

      # 8. Disk Space
      - name: Disk Space
        run: |
          echo "=== DISK SPACE ==="
          df -h

      # 9. Environment Variables
      - name: Environment Variables
        run: |
          echo "=== ENVIRONMENT VARIABLES ==="
          echo "PATH (first 20 entries):"
          echo "$PATH" | tr ':' '\n' | head -20
          echo ""
          echo "Selected GitHub env vars:"
          echo "  RUNNER_OS: $RUNNER_OS"
          echo "  RUNNER_ARCH: $RUNNER_ARCH"
          echo "  GITHUB_REPOSITORY: $GITHUB_REPOSITORY"
          echo "  GITHUB_RUN_ID: $GITHUB_RUN_ID"

      # 10. Create Issue with Diagnostics (only on workflow_dispatch)
      - name: Create Issue with Diagnostics
        if: github.event_name == 'workflow_dispatch'
        run: |
          HOSTNAME=$(hostname)
          OS=$(uname -a)
          CORES=$(nproc)
          MEMORY=$(free -h | head -3)
          DOCKER_VERSION=$(docker --version 2>/dev/null || echo "Not installed")
          PYTHON_VERSION=$(python3 --version 2>/dev/null || python --version 2>/dev/null || echo "Not installed")
          GIT_VERSION=$(git --version 2>/dev/null || echo "Not installed")
          NODE_VERSION=$(node --version 2>/dev/null || echo "Not installed")
          NPM_VERSION=$(npm --version 2>/dev/null || echo "Not installed")
          DISK=$(df -h | head -5)
          
          # Write issue body to file
          cat > /tmp/issue_body.txt << 'ENDOFISSUE'
          ## Runner Diagnostics Report

          **Run ID:** $RUN_ID
          **Workflow:** CI
          **Runner:** imprunner (self-hosted Linux X64)

          ### System Information
          - Hostname: $HOSTNAME
          - OS: $OS

          ### CPU and Memory
          - CPU cores: $CORES
          - Memory:
          ```
          $MEMORY
          ```

          ### Docker
          $DOCKER_VERSION

          ### Python
          $PYTHON_VERSION

          ### Node.js / npm
          Node: $NODE_VERSION
          npm: $NPM_VERSION

          ### Git
          $GIT_VERSION

          ### Disk Space
          ```
          $DISK
          ```

          ---
          *This issue was automatically created by the CI diagnostic workflow.*
          ENDOFISSUE
          
          # Replace variables in the file
          sed -i "s/\$RUN_ID/$GITHUB_RUN_ID/g" /tmp/issue_body.txt
          sed -i "s/\$HOSTNAME/$HOSTNAME/g" /tmp/issue_body.txt
          sed -i "s/\$OS/$OS/g" /tmp/issue_body.txt
          sed -i "s/\$CORES/$CORES/g" /tmp/issue_body.txt
          sed -i "s/\$MEMORY/$MEMORY/g" /tmp/issue_body.txt
          sed -i "s/\$DOCKER_VERSION/$DOCKER_VERSION/g" /tmp/issue_body.txt
          sed -i "s/\$PYTHON_VERSION/$PYTHON_VERSION/g" /tmp/issue_body.txt
          sed -i "s/\$GIT_VERSION/$GIT_VERSION/g" /tmp/issue_body.txt
          sed -i "s/\$NODE_VERSION/$NODE_VERSION/g" /tmp/issue_body.txt
          sed -i "s/\$NPM_VERSION/$NPM_VERSION/g" /tmp/issue_body.txt
          sed -i "s/\$DISK/$DISK/g" /tmp/issue_body.txt
          
          # Create the issue
          gh issue create \
            --repo "$GITHUB_REPOSITORY" \
            --title "Runner Diagnostics - $(date +'%Y-%m-%d')" \
            --body-file /tmp/issue_body.txt

  # Lint and test job (runs after diagnostics)
  ci:
    runs-on: imprunner
    needs: diagnostics
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f pyproject.toml ]; then pip install -e .; fi

      - name: Lint with flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run tests with pytest
        run: |
          pytest --version || true

      # 11. Install GitHub CLI (if not present)
      - name: Install GitHub CLI
        if: github.event_name == 'push'
        run: |
          if ! command -v gh &> /dev/null; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            apt update
            apt install gh
          fi

      # 12. Create Summary Issue (only on push events)
      - name: Create Summary Issue
        if: github.event_name == 'push'
        run: |
          # Get branch and commit info
          BRANCH_NAME="${{ github.ref_name }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Create issue body using heredoc to properly handle special characters
          tee /tmp/summary_issue_body.txt > /dev/null << EOF
          ## CI Summary Report

          **Branch:** $BRANCH_NAME
          **Commit:** $COMMIT_SHA
          **Run URL:** $RUN_URL

          ### Commit Message
          $COMMIT_MSG

          ---
          *This issue was automatically created by the CI workflow on push to a non-main branch.*
          EOF
          
          # Create the issue
          gh issue create \
            --repo "$GITHUB_REPOSITORY" \
            --title "CI Summary - $BRANCH_NAME - $(date +'%Y-%m-%d')" \
            --body-file /tmp/summary_issue_body.txt
